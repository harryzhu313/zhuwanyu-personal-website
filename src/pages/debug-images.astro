---
import { getNotionPhotos } from "../utils/notion-photos";

let debugResults: {
  photos: any[];
  totalCount: number;
  localizedCount: number;
  remoteCount: number;
  errors: string[];
} = {
  photos: [],
  totalCount: 0,
  localizedCount: 0,
  remoteCount: 0,
  errors: [],
};

try {
  const photos = await getNotionPhotos();
  debugResults.photos = photos.map(photo => ({
    title: photo.title,
    originalUrl: photo.image,
    isLocalPath: photo.image.startsWith('/_astro/'),
    isHttpUrl: photo.image.startsWith('http'),
    pathAnalysis: {
      hasAstroPrefix: photo.image.includes('/_astro/'),
      hasWebpExtension: photo.image.includes('.webp'),
      hasHash: photo.image.match(/_[a-zA-Z0-9]{8}\./),
    },
    imageStatus: photo.isRemote ? 'è¿œç¨‹å›¾ç‰‡' : 'æœ¬åœ°åŒ–æˆåŠŸ',
  }));
  
  debugResults.totalCount = photos.length;
  debugResults.localizedCount = photos.filter(p => !p.isRemote).length;
  debugResults.remoteCount = photos.filter(p => p.isRemote).length;
  
} catch (error) {
  debugResults.errors.push(String(error));
}
---

<!DOCTYPE html>
<html>
<head>
  <title>å›¾ç‰‡æœ¬åœ°åŒ–è°ƒè¯•</title>
  <style>
    body { 
      font-family: system-ui, sans-serif; 
      padding: 20px; 
      line-height: 1.6;
    }
    .success { color: #22c55e; font-weight: bold; }
    .warning { color: #f59e0b; font-weight: bold; }
    .error { color: #ef4444; font-weight: bold; }
    .card { 
      border: 1px solid #e5e7eb; 
      border-radius: 8px; 
      padding: 16px; 
      margin: 12px 0;
      background: #f9fafb;
    }
    .status-local { background: #dcfce7; border-color: #22c55e; }
    .status-remote { background: #fef3c7; border-color: #f59e0b; }
    .url-display { 
      font-family: monospace; 
      background: #1f2937; 
      color: #f3f4f6; 
      padding: 8px; 
      border-radius: 4px; 
      word-break: break-all;
      margin: 8px 0;
    }
    .stats { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 16px; 
      margin: 20px 0;
    }
    .stat-card {
      background: white;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      text-align: center;
    }
    .test-section {
      background: #eff6ff;
      border: 1px solid #3b82f6;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>ğŸ” å›¾ç‰‡æœ¬åœ°åŒ–çŠ¶æ€è°ƒè¯•</h1>
  
  <div class="stats">
    <div class="stat-card">
      <h3>æ€»ç…§ç‰‡æ•°</h3>
      <div style="font-size: 2em; color: #3b82f6;">{debugResults.totalCount}</div>
    </div>
    <div class="stat-card">
      <h3>æœ¬åœ°åŒ–æˆåŠŸ</h3>
      <div style="font-size: 2em; color: #22c55e;">{debugResults.localizedCount}</div>
    </div>
    <div class="stat-card">
      <h3>ä»ä¸ºè¿œç¨‹</h3>
      <div style="font-size: 2em; color: #f59e0b;">{debugResults.remoteCount}</div>
    </div>
  </div>

  <div class="test-section">
    <h2>ğŸ§ª éªŒè¯æ–¹æ³•</h2>
    <p><strong>æœ¬åœ°åŒ–æˆåŠŸçš„ç‰¹å¾ï¼š</strong></p>
    <ul>
      <li>âœ… URL ä»¥ <code>/_astro/</code> å¼€å¤´</li>
      <li>âœ… åŒ…å«å“ˆå¸Œå€¼ï¼ˆå¦‚ <code>_1msJ8H</code>ï¼‰</li>
      <li>âœ… ä»¥ <code>.webp</code> ç»“å°¾ï¼ˆä¼˜åŒ–æ ¼å¼ï¼‰</li>
      <li>âœ… åœ¨æµè§ˆå™¨ä¸­èƒ½æ­£å¸¸åŠ è½½ï¼ˆä¸ä¼š404ï¼‰</li>
    </ul>
    <p><strong>æµ‹è¯•æ­¥éª¤ï¼š</strong></p>
    <ol>
      <li>æ£€æŸ¥ä¸‹é¢æ¯å¼ å›¾ç‰‡çš„URLæ ¼å¼</li>
      <li>å³é”®ç‚¹å‡»å›¾ç‰‡ â†’ "åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å›¾ç‰‡"</li>
      <li>å¦‚æœèƒ½æ­£å¸¸æ˜¾ç¤ºä¸”URLæ˜¯ /_astro/ æ ¼å¼ï¼Œè¯´æ˜æœ¬åœ°åŒ–æˆåŠŸ</li>
    </ol>
  </div>

  <h2>ğŸ“¸ è¯¦ç»†å›¾ç‰‡åˆ†æ</h2>
  
  {debugResults.photos.length > 0 ? (
    debugResults.photos.map((photo, index) => (
      <div class={`card ${photo.isLocalPath ? 'status-local' : 'status-remote'}`}>
        <h3>{photo.title}</h3>
        
        <p class={photo.isLocalPath ? 'success' : 'warning'}>
          çŠ¶æ€: {photo.imageStatus}
        </p>
        
        <div>
          <strong>å›¾ç‰‡URL:</strong>
          <div class="url-display">{photo.originalUrl}</div>
        </div>
        
        <div style="margin: 12px 0;">
          <strong>è·¯å¾„åˆ†æ:</strong>
          <ul style="margin: 8px 0; padding-left: 20px;">
            <li class={photo.pathAnalysis.hasAstroPrefix ? 'success' : 'error'}>
              Astroè·¯å¾„å‰ç¼€: {photo.pathAnalysis.hasAstroPrefix ? 'âœ…' : 'âŒ'}
            </li>
            <li class={photo.pathAnalysis.hasWebpExtension ? 'success' : 'warning'}>
              WebPæ ¼å¼: {photo.pathAnalysis.hasWebpExtension ? 'âœ…' : 'âŒ'}
            </li>
            <li class={photo.pathAnalysis.hasHash ? 'success' : 'warning'}>
              åŒ…å«å“ˆå¸Œ: {photo.pathAnalysis.hasHash ? 'âœ…' : 'âŒ'}
            </li>
          </ul>
        </div>
        
        <div style="margin: 12px 0;">
          <strong>æµ‹è¯•å›¾ç‰‡åŠ è½½:</strong>
          <div style="margin: 8px 0;">
            <img 
              src={photo.originalUrl} 
              alt={photo.title}
              style="max-width: 200px; max-height: 150px; border: 1px solid #ccc; border-radius: 4px;"
              onload="this.nextElementSibling.textContent = 'âœ… åŠ è½½æˆåŠŸ'"
              onerror="this.nextElementSibling.textContent = 'âŒ åŠ è½½å¤±è´¥'"
            />
            <div style="margin-top: 4px; font-weight: bold;">åŠ è½½çŠ¶æ€æ£€æµ‹ä¸­...</div>
          </div>
        </div>
      </div>
    ))
  ) : (
    <div class="card status-remote">
      <p class="error">âŒ æ²¡æœ‰æ‰¾åˆ°ç…§ç‰‡æ•°æ®</p>
    </div>
  )}

  {debugResults.errors.length > 0 && (
    <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px; margin: 20px 0;">
      <h3 class="error">é”™è¯¯ä¿¡æ¯:</h3>
      {debugResults.errors.map(error => (
        <div class="url-display" style="background: #7f1d1d; color: #fca5a5;">
          {error}
        </div>
      ))}
    </div>
  )}

  <hr style="margin: 30px 0;">
  <p>
    <a href="/">â† è¿”å›é¦–é¡µ</a> | 
    <a href="/photos">æŸ¥çœ‹ç…§ç‰‡é¡µé¢</a> | 
    <a href="/debug-notion">Notionè¿æ¥è°ƒè¯•</a>
  </p>
</body>
</html> 