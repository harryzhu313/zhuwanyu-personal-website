---
import { getCollection } from "astro:content";
import CollectionLayout from "../../layouts/CollectionLayout.astro";
import { slugify, yymmdd, type Music } from "../..";
import Introduction from "../../components/Introduction.astro";
import { preprocessMusic } from "../../content/config";

// 安全获取 musics 集合
let musics;
let nodes: Music[] = [];

try {
  musics = await getCollection("musics");
  if (musics && musics.length > 0) {
    nodes = await Promise.all(musics.map(preprocessMusic));
  }
} catch (error) {
  console.error("获取 musics 集合时出错:", error);
  nodes = [];
}
---

<CollectionLayout collection="musics">
  <Introduction collection="musics">
    <p>
      德国哲学家莱布尼茨曾对音乐作过这样的阐释：「音乐是心灵的算术练习，心灵在听音乐时计算着自己而不自知。」
    </p>
    <p>本页面正在建设中，过一段时间回来看看会发现更多内容哦～</p>
  </Introduction>
  <section class="section">
    {
      nodes.length > 0 ? (
        nodes.map(
          ({ title: name, date, opus, number, categories: category }: Music) => (
            <article class="container content is-max-desktop">
              <h2>
                <a href={slugify(name)}>{name}</a>
              </h2>
              <p>
                {category}，Op. {opus}, No. {number}
              </p>
              <p>{yymmdd(date)}</p>
            </article>
          )
        )
      ) : (
        <div class="container content is-max-desktop">
          <p>音乐集合正在建设中，请稍后再来查看。</p>
        </div>
      )
    }
  </section>
</CollectionLayout>
